import React, { useState, useEffect, useRef } from 'react';

// Main App component
const App = () => {
    // State for the address input field
    const [address, setAddress] = useState('');
    // State to indicate if the map search is in progress
    const [loadingMap, setLoadingMap] = useState(false);
    // State to store any error messages related to the map search
    const [mapError, setMapError] = useState(null);
    // useRef hook to get a direct reference to the map container DOM element
    const mapRef = useRef(null);
    // useRef hook to store the Leaflet map instance
    const leafletMapRef = useRef(null);
    // useRef hook to store the Leaflet marker instance
    const markerRef = useRef(null);

    // useEffect hook to dynamically load Leaflet CSS and JavaScript
    // This runs once when the component mounts
    useEffect(() => {
        const loadLeaflet = async () => {
            // Create a link element for Leaflet CSS and append it to the document head
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.css';
            document.head.appendChild(link);

            // Create a script element for Leaflet JavaScript and append it to the document body
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.js';
            // Set onload callback to initialize the map once Leaflet is loaded
            script.onload = () => {
                console.log('Leaflet loaded successfully');
                // Initialize the map only if the map container exists and the map hasn't been initialized yet
                if (mapRef.current && !leafletMapRef.current) {
                    // Create a new Leaflet map instance, set initial view to [0,0] with zoom 2
                    leafletMapRef.current = window.L.map(mapRef.current).setView([0, 0], 2);
                    // Add OpenStreetMap tile layer to the map
                    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(leafletMapRef.current);
                }
            };
            // Set onerror callback to handle issues with loading Leaflet
            script.onerror = () => {
                setMapError('Failed to load map library.');
            };
            document.body.appendChild(script);

            // Cleanup function: remove the added link and script elements when the component unmounts
            return () => {
                document.head.removeChild(link);
                document.body.removeChild(script);
                // If a map instance exists, remove it to prevent memory leaks
                if (leafletMapRef.current) {
                    leafletMapRef.current.remove();
                    leafletMapRef.current = null;
                }
            };
        };

        loadLeaflet(); // Call the function to load Leaflet
    }, []); // Empty dependency array ensures this effect runs only once on mount

    // Function to handle the address search
    const handleSearch = async () => {
        // Basic validation: check if address input is empty
        if (!address.trim()) {
            setMapError('Please enter an address.');
            return;
        }
        // Check if Leaflet library has been loaded
        if (!window.L) {
            setMapError('Map library not loaded yet. Please wait.');
            return;
        }

        setLoadingMap(true); // Set loading state to true
        setMapError(null); // Clear any previous error messages

        try {
            // Fetch geocoding data from OpenStreetMap Nominatim API
            // encodeURIComponent is used to properly format the address for the URL
            const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`);
            const data = await response.json(); // Parse the JSON response

            // Check if data was returned and if it contains results
            if (data && data.length > 0) {
                const { lat, lon } = data[0]; // Extract latitude and longitude
                const newLat = parseFloat(lat);
                const newLon = parseFloat(lon);

                // If Leaflet map instance exists, update its view and marker
                if (leafletMapRef.current) {
                    leafletMapRef.current.setView([newLat, newLon], 13); // Set map view to the found coordinates with zoom level 13
                    // If a marker already exists, update its position
                    if (markerRef.current) {
                        markerRef.current.setLatLng([newLat, newLon]);
                    } else {
                        // Otherwise, create a new marker and add it to the map
                        markerRef.current = window.L.marker([newLat, newLon]).addTo(leafletMapRef.current)
                            .bindPopup(data[0].display_name) // Bind a popup with the address display name
                            .openPopup(); // Open the popup immediately
                    }
                }
            } else {
                setMapError('Address not found. Please try a different address.'); // Set error if no results found
            }
        } catch (error) {
            console.error('Error fetching geocoding data:', error);
            setMapError('Error searching for address. Please try again.'); // Set error for fetch failures
        } finally {
            setLoadingMap(false); // Set loading state to false after search completes
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 font-sans antialiased">
            {/* Hero Section */}
            <section
                className="relative h-96 bg-cover bg-center rounded-b-lg shadow-lg"
                // Using a placeholder image for the hero section
                style={{ backgroundImage: "url('https://placehold.co/1200x400/000000/FFFFFF?text=Hero+Image')" }}
            >
                <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-b-lg">
                    <h1 className="text-white text-4xl md:text-6xl font-bold text-center p-4">
                        Welcome to Our Awesome Page
                    </h1>
                </div>
            </section>

            {/* Three Images Section */}
            <section className="py-16 px-4 md:px-8 lg:px-16">
                <h2 className="text-3xl font-bold text-center text-gray-800 mb-12">Our Featured Content</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                    {/* Image 1 */}
                    <div className="bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105">
                        <img
                            src="https://placehold.co/400x300/FF5733/FFFFFF?text=Image+One"
                            alt="Description for Image One"
                            className="w-full h-48 object-cover"
                        />
                        <div className="p-6">
                            <h3 className="text-xl font-semibold text-gray-800 mb-2">Captivating Scene</h3>
                            <p className="text-gray-600 text-sm">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                            </p>
                        </div>
                    </div>
                    {/* Image 2 */}
                    <div className="bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105">
                        <img
                            src="https://placehold.co/400x300/33FF57/FFFFFF?text=Image+Two"
                            alt="Description for Image Two"
                            className="w-full h-48 object-cover"
                        />
                        <div className="p-6">
                            <h3 className="text-xl font-semibold text-gray-800 mb-2">Vibrant Display</h3>
                            <p className="text-gray-600 text-sm">
                                Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                            </p>
                        </div>
                    </div>
                    {/* Image 3 */}
                    <div className="bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105">
                        <img
                            src="https://placehold.co/400x300/3357FF/FFFFFF?text=Image+Three"
                            alt="Description for Image Three"
                            className="w-full h-48 object-cover"
                        />
                        <div className="p-6">
                            <h3 className="text-xl font-semibold text-gray-800 mb-2">Inspiring View</h3>
                            <p className="text-gray-600 text-sm">
                                Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            {/* Address Search and Map Section */}
            <section className="py-16 px-4 md:px-8 lg:px-16 bg-gray-200 rounded-t-lg shadow-inner">
                <h2 className="text-3xl font-bold text-center text-gray-800 mb-12">Find Us on the Map</h2>
                <div className="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
                    <div className="flex flex-col sm:flex-row gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="Enter an address (e.g., 1600 Amphitheatre Parkway, Mountain View)"
                            className="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={address}
                            onChange={(e) => setAddress(e.target.value)}
                            // Allow searching by pressing Enter key
                            onKeyPress={(e) => {
                                if (e.key === 'Enter') {
                                    handleSearch();
                                }
                            }}
                        />
                        <button
                            onClick={handleSearch}
                            className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled={loadingMap} // Disable button while loading
                        >
                            {loadingMap ? 'Searching...' : 'Search Address'}
                        </button>
                    </div>
                    {/* Display error message if any */}
                    {mapError && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <span className="block sm:inline">{mapError}</span>
                        </div>
                    )}
                    {/* Map container */}
                    <div
                        id="mapid"
                        ref={mapRef} // Assign ref to the map container
                        className="w-full h-96 bg-gray-300 rounded-md shadow-inner relative"
                        style={{ minHeight: '300px' }} // Ensure a minimum height for the map
                    >
                        {/* Loading indicator overlay for the map */}
                        {loadingMap && (
                            <div className="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10 rounded-md">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
                            </div>
                        )}
                    </div>
                </div>
            </section>

            {/* Footer */}
            <footer className="bg-gray-800 text-white text-center p-6 mt-8 rounded-t-lg">
                <p>&copy; 2023 Our Awesome Page. All rights reserved.</p>
            </footer>
        </div>
    );
};

export default App;
